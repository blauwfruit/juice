#!/bin/bash

# Install necessary packages (rsync, git) if not installed
if ! command -v rsync &> /dev/null; then
  echo "rsync is not installed, installing..."
  apt-get update && apt-get install -y git rsync
  if [[ $? -ne 0 ]]; then
    echo "Failed to install rsync. Exiting."
    exit 1
  fi
else
  echo "rsync is already installed."
fi

source .juice_setup
source app/constants
source app/functions

# Call the check script and exit if it fails
bash juice/check

check_status=$?
if [ $check_status -ne 0 ]; then
  echo "Check script failed with status $check_status. Aborting upgrade."
  exit $check_status
fi


# If check is successful, continue process

success "Start upgrade"

if [[ -f "$APPLICATION_PATH/blauwfruit-juice-upgrade-$PRESTASHOP_NEW_VERSION-hook-before" ]]; then

  bash "$APPLICATION_PATH/blauwfruit-juice-upgrade-$PRESTASHOP_NEW_VERSION-hook-before"

  if [[ $? -eq 0 ]]; then
    success "Upgrade Hook before executed without errors"
  else
    warning "Upgrade Hook before script has failed. See script " . "$APPLICATION_PATH/blauwfruit-juice-upgrade-hook-before"
    warning "You're upgrade might still be successfully executed"
  fi
fi

# Get current PrestaShop version
currentVersion=$(php -r "include '${APPLICATION_PATH}/config/config.inc.php';echo _PS_VERSION_;")
info "Current PrestaShop version: $currentVersion"
info "Target PrestaShop version: $PRESTASHOP_NEW_VERSION"
info "Using autoupgrade module version: $AUTOUPGRADE_VERSION"

# Determine if we're using autoupgrade v7.x or older
# v7.x uses Symfony console commands instead of cli-*.php scripts
AUTOUPGRADE_MAJOR_VERSION=$(echo "$AUTOUPGRADE_VERSION" | sed 's/^v//' | cut -d'.' -f1)
if [[ "$AUTOUPGRADE_MAJOR_VERSION" -ge 7 ]]; then
    AUTOUPGRADE_V7=true
    info "Detected autoupgrade v7.x or newer - using Symfony console commands"
else
    AUTOUPGRADE_V7=false
    info "Detected autoupgrade v6.x or older - using legacy CLI scripts"
fi

# For v7.x, we need the bin/console file - always download the correct version
# (existing module might be outdated and missing bin/console)
if [[ "$AUTOUPGRADE_V7" == true ]]; then
    if [ -f "${APPLICATION_PATH}/modules/autoupgrade/bin/console" ]; then
        info "Autoupgrade module with bin/console already exists."
    else
        info "Downloading autoupgrade ${AUTOUPGRADE_VERSION} (v7.x requires bin/console)..."
        # Remove old module if it exists (might be outdated version without bin/console)
        rm -rf "${APPLICATION_PATH}/modules/autoupgrade"
        rm -f "${APPLICATION_PATH}/modules/autoupgrade.zip"
        
        # Download and install new Autoupgrade
        curl -L "https://github.com/PrestaShop/autoupgrade/releases/download/${AUTOUPGRADE_VERSION}/autoupgrade-${AUTOUPGRADE_VERSION}.zip" -o "${APPLICATION_PATH}/modules/autoupgrade.zip"
        unzip -o "${APPLICATION_PATH}/modules/autoupgrade.zip" -d "${APPLICATION_PATH}/modules/"
        
        # Make bin/console executable
        if [ -f "${APPLICATION_PATH}/modules/autoupgrade/bin/console" ]; then
            chmod +x "${APPLICATION_PATH}/modules/autoupgrade/bin/console"
            info "Made bin/console executable"
        else
            warning "bin/console not found after extraction. Checking module structure..."
            ls -la "${APPLICATION_PATH}/modules/autoupgrade/"
            ls -la "${APPLICATION_PATH}/modules/autoupgrade/bin/" 2>/dev/null || warning "bin/ directory not found"
        fi
    fi
else
    # For v6.x, check if module exists
    if [ -f "${APPLICATION_PATH}/modules/autoupgrade/autoupgrade.php" ]; then
        info "Autoupgrade module already exists, skipping download."
    else
        info "Autoupgrade module does not exist, downloading and installing."

        # Download and install new Autoupgrade
        curl -L "https://github.com/PrestaShop/autoupgrade/releases/download/${AUTOUPGRADE_VERSION}/autoupgrade-${AUTOUPGRADE_VERSION}.zip" -o "${APPLICATION_PATH}/modules/autoupgrade.zip"
        unzip -o "${APPLICATION_PATH}/modules/autoupgrade.zip" -d "${APPLICATION_PATH}/modules/"
    fi
fi

# Install the autoupgrade module
# For v7.x, prefer direct installation to avoid issues with main bin/console
# (ps_checkout and other modules can cause YAML parsing errors during kernel boot)
if [[ "$AUTOUPGRADE_V7" == true ]]; then
    info "Installing autoupgrade module directly (v7.x mode)..."
    php -r "
    define('_PS_ADMIN_DIR_', '${APPLICATION_PATH}/${BACKOFFICE_FOLDER}');
    // Only include config, not init.php - init.php triggers FrontController->init()
    // which fails in CLI mode because there's no customer context
    include '${APPLICATION_PATH}/config/config.inc.php';
    // Manually initialize what we need for module installation
    if (!defined('_PS_VERSION_')) {
        die('PrestaShop configuration not loaded properly');
    }
    // Initialize context minimally for CLI
    \$context = Context::getContext();
    if (!\$context->shop || !\$context->shop->id) {
        \$context->shop = new Shop(Configuration::get('PS_SHOP_DEFAULT'));
    }
    if (!\$context->language || !\$context->language->id) {
        \$context->language = new Language(Configuration::get('PS_LANG_DEFAULT'));
    }
    if (!\$context->currency || !\$context->currency->id) {
        \$context->currency = new Currency(Configuration::get('PS_CURRENCY_DEFAULT'));
    }
    // Create a minimal employee context for module installation
    if (!\$context->employee || !\$context->employee->id) {
        \$context->employee = new Employee();
        \$context->employee->id = 1;
        \$context->employee->id_profile = 1;
    }
    \$module = Module::getInstanceByName('autoupgrade');
    if (!\$module) {
        require_once '${APPLICATION_PATH}/modules/autoupgrade/autoupgrade.php';
        \$module = new autoupgrade();
    }
    if (!Module::isInstalled('autoupgrade')) {
        \$module->install();
        echo 'Module autoupgrade installed successfully' . PHP_EOL;
    } else {
        echo 'Module autoupgrade already installed' . PHP_EOL;
    }
    "
elif [ -f "${APPLICATION_PATH}/bin/console" ]; then
    php "${APPLICATION_PATH}/bin/console" prestashop:module install autoupgrade
else
    # For older PrestaShop versions without bin/console, install module directly
    info "bin/console not available, installing module directly"
    php -r "
    define('_PS_ADMIN_DIR_', '${APPLICATION_PATH}/${BACKOFFICE_FOLDER}');
    // Only include config, not init.php - init.php triggers FrontController->init()
    // which fails in CLI mode because there's no customer context
    include '${APPLICATION_PATH}/config/config.inc.php';
    // Initialize context minimally for CLI
    \$context = Context::getContext();
    if (!\$context->shop || !\$context->shop->id) {
        \$context->shop = new Shop(Configuration::get('PS_SHOP_DEFAULT'));
    }
    if (!\$context->language || !\$context->language->id) {
        \$context->language = new Language(Configuration::get('PS_LANG_DEFAULT'));
    }
    if (!\$context->currency || !\$context->currency->id) {
        \$context->currency = new Currency(Configuration::get('PS_CURRENCY_DEFAULT'));
    }
    // Create a minimal employee context for module installation
    if (!\$context->employee || !\$context->employee->id) {
        \$context->employee = new Employee();
        \$context->employee->id = 1;
        \$context->employee->id_profile = 1;
    }
    \$module = Module::getInstanceByName('autoupgrade');
    if (!\$module) {
        require_once '${APPLICATION_PATH}/modules/autoupgrade/autoupgrade.php';
        \$module = new autoupgrade();
    }
    if (!Module::isInstalled('autoupgrade')) {
        \$module->install();
        echo 'Module autoupgrade installed successfully' . PHP_EOL;
    } else {
        echo 'Module autoupgrade already installed' . PHP_EOL;
    }
    "
fi

mkdir -p "$APPLICATION_PATH/$BACKOFFICE_FOLDER/autoupgrade/download"

# Download the PrestaShop zip and XML files to the download directory
curl -L "https://github.com/PrestaShop/PrestaShop/releases/download/${PRESTASHOP_NEW_VERSION}/prestashop_${PRESTASHOP_NEW_VERSION}.zip" -o "$APPLICATION_PATH/$BACKOFFICE_FOLDER/autoupgrade/download/prestashop.zip"
curl -L "https://github.com/PrestaShop/PrestaShop/releases/download/${PRESTASHOP_NEW_VERSION}/prestashop_${PRESTASHOP_NEW_VERSION}.xml" -o "$APPLICATION_PATH/$BACKOFFICE_FOLDER/autoupgrade/download/prestashop.xml"

chown -R www-data:www-data "${APPLICATION_PATH}/modules/"
chmod -R 755 "${APPLICATION_PATH}/modules/"

if [ "$AUTOUPGRADE_V7" = true ]; then
    # Autoupgrade v7.x has its own bin/console inside the module directory
    # This bypasses the main PrestaShop kernel and avoids module loading issues
    info "Running upgrade using autoupgrade v7.x CLI..."
    
    # Verify bin/console exists before attempting to run
    if [ ! -f "${APPLICATION_PATH}/modules/autoupgrade/bin/console" ]; then
        danger "bin/console not found at ${APPLICATION_PATH}/modules/autoupgrade/bin/console. Check if autoupgrade module was properly extracted."
    fi
    
    # Ensure bin/console is executable
    chmod +x "${APPLICATION_PATH}/modules/autoupgrade/bin/console"
    
    # Run the upgrade with local archive files using the module's own console
    # The --zip and --xml options specify the archive files in the download folder
    php "${APPLICATION_PATH}/modules/autoupgrade/bin/console" update:start "${BACKOFFICE_FOLDER}" \
        --zip="prestashop.zip" \
        --xml="prestashop.xml" \
        --no-interaction
else
    # Autoupgrade v6.x and older use the legacy cli-*.php scripts
    info "Running upgrade using autoupgrade v6.x legacy CLI..."
    
    # Create the Autoupgrade config file (legacy format)
    echo "{\"channel\":\"archive\",\"archive_prestashop\":\"prestashop.zip\",\"archive_num\":\"$PRESTASHOP_NEW_VERSION\",\"archive_xml\":\"prestashop.xml\",\"PS_AUTOUP_CHANGE_DEFAULT_THEME\":0,\"PS_AUTOUP_BACKUP\": 0,\"PS_AUTOUP_KEEP_IMAGES\": 0,\"PS_AUTOUP_PERFORMANCE\": 2,\"PS_AUTOUP_CUSTOM_MOD_DESACT\": 1,\"PS_DISABLE_OVERRIDES\": 0,\"PS_AUTOUP_UPDATE_DEFAULT_THEME\": 0,\"PS_AUTOUP_CHANGE_DEFAULT_THEME\": 0,\"PS_AUTOUP_UPDATE_RTL_FILES\": 0,\"PS_AUTOUP_KEEP_MAILS\": 1,\"skip_backup\": 1}" > "$APPLICATION_PATH/modules/autoupgrade/config.json"
    
    # Apply the config file
    php "${APPLICATION_PATH}/modules/autoupgrade/cli-updateconfig.php" --from="${APPLICATION_PATH}/modules/autoupgrade/config.json" --dir="${BACKOFFICE_FOLDER}"
    
    # Run the upgrade
    php "${APPLICATION_PATH}/modules/autoupgrade/cli-upgrade.php" --dir="${BACKOFFICE_FOLDER}"
fi

info "Change owner to www-data:www-data and set permissions (755 for dirs, 644 for files)"
chown -R www-data:www-data "${APPLICATION_PATH}"
chmod -R u=rwX,go=rX "${APPLICATION_PATH}"

if [[ -f "${APPLICATION_PATH}/blauwfruit-juice-upgrade-${PRESTASHOP_NEW_VERSION}-hook-after" ]]; then

  bash "${APPLICATION_PATH}/blauwfruit-juice-upgrade-${PRESTASHOP_NEW_VERSION}-hook-after"

  if [[ $? -eq 0 ]]; then
    success "Upgrade Hook After executed without errors"
  else
    warning "Upgrade Hook After script has failed. See script " . "${APPLICATION_PATH}/blauwfruit-juice-upgrade-hook-after"
    warning "You're upgrade might still be successfully executed"
  fi
fi

success "See the front-office $SHOP_URL"
success "See the back-office $SHOP_URL/$BACKOFFICE_FOLDER"
