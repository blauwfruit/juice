#!/bin/bash

# Install necessary packages (rsync, git) if not installed
if ! command -v rsync &> /dev/null; then
  echo "rsync is not installed, installing..."
  apt-get update && apt-get install -y git rsync
  if [[ $? -ne 0 ]]; then
    echo "Failed to install rsync. Exiting."
    exit 1
  fi
else
  echo "rsync is already installed."
fi

source .juice_setup
source app/constants
source app/functions

# Call the check script and exit if it fails
bash juice/check

check_status=$?
if [ $check_status -ne 0 ]; then
  echo "Check script failed with status $check_status. Aborting upgrade."
  exit $check_status
fi


# If check is successful, continue process

success "Start upgrade"

if [[ -f "$APPLICATION_PATH/blauwfruit-juice-upgrade-$PRESTASHOP_NEW_VERSION-hook-before" ]]; then

  bash "$APPLICATION_PATH/blauwfruit-juice-upgrade-$PRESTASHOP_NEW_VERSION-hook-before"

  if [[ $? -eq 0 ]]; then
    success "Upgrade Hook before executed without errors"
  else
    warning "Upgrade Hook before script has failed. See script " . "$APPLICATION_PATH/blauwfruit-juice-upgrade-hook-before"
    warning "You're upgrade might still be successfully executed"
  fi
fi

# Get current PrestaShop version
currentVersion=$(php -r "include '${APPLICATION_PATH}/config/config.inc.php';echo _PS_VERSION_;")
info "Current PrestaShop version: $currentVersion"
info "Target PrestaShop version: $PRESTASHOP_NEW_VERSION"
info "Using autoupgrade module version: $AUTOUPGRADE_VERSION"

# Check if autoupgrade module already exists
if [ -f "${APPLICATION_PATH}/modules/autoupgrade/autoupgrade.php" ]; then
    info "Autoupgrade module already exists, skipping download."
else
    info "Autoupgrade module does not exist, downloading and installing."

    # Download and install new Autoupgrade
    curl -L "https://github.com/PrestaShop/autoupgrade/releases/download/${AUTOUPGRADE_VERSION}/autoupgrade-${AUTOUPGRADE_VERSION}.zip" -o "${APPLICATION_PATH}/modules/autoupgrade.zip"
    unzip -o "${APPLICATION_PATH}/modules/autoupgrade.zip" -d "${APPLICATION_PATH}/modules/"
fi

# Install the autoupgrade module via console if available, otherwise try direct installation
if [ -f "${APPLICATION_PATH}/bin/console" ]; then
    php "${APPLICATION_PATH}/bin/console" prestashop:module install autoupgrade
else
    # For older PrestaShop versions without bin/console, install module directly
    info "bin/console not available, installing module directly"
    php -r "
    include '${APPLICATION_PATH}/config/config.inc.php';
    include '${APPLICATION_PATH}/init.php';
    \$module = Module::getInstanceByName('autoupgrade');
    if (!\$module) {
        require_once '${APPLICATION_PATH}/modules/autoupgrade/autoupgrade.php';
        \$module = new autoupgrade();
    }
    if (!\Module::isInstalled('autoupgrade')) {
        \$module->install();
    }
    "
fi

mkdir -p "$APPLICATION_PATH/$BACKOFFICE_FOLDER/autoupgrade/download"

# Download the PrestaShop zip and XML files to the download directory
curl -L "https://github.com/PrestaShop/PrestaShop/releases/download/${PRESTASHOP_NEW_VERSION}/prestashop_${PRESTASHOP_NEW_VERSION}.zip" -o "$APPLICATION_PATH/$BACKOFFICE_FOLDER/autoupgrade/download/prestashop.zip"
curl -L "https://github.com/PrestaShop/PrestaShop/releases/download/${PRESTASHOP_NEW_VERSION}/prestashop_${PRESTASHOP_NEW_VERSION}.xml" -o "$APPLICATION_PATH/$BACKOFFICE_FOLDER/autoupgrade/download/prestashop.xml"

# Create the Autoupgrade config file
echo "{\"channel\":\"archive\",\"archive_prestashop\":\"prestashop.zip\",\"archive_num\":\"$PRESTASHOP_NEW_VERSION\",\"archive_xml\":\"prestashop.xml\",\"PS_AUTOUP_CHANGE_DEFAULT_THEME\":0,\"PS_AUTOUP_BACKUP\": 0,\"PS_AUTOUP_KEEP_IMAGES\": 0,\"PS_AUTOUP_PERFORMANCE\": 2,\"PS_AUTOUP_CUSTOM_MOD_DESACT\": 1,\"PS_DISABLE_OVERRIDES\": 0,\"PS_AUTOUP_UPDATE_DEFAULT_THEME\": 0,\"PS_AUTOUP_CHANGE_DEFAULT_THEME\": 0,\"PS_AUTOUP_UPDATE_RTL_FILES\": 0,\"PS_AUTOUP_KEEP_MAILS\": 1,\"skip_backup\": 1}" > "$APPLICATION_PATH/modules/autoupgrade/config.json"

chown -R www-data:www-data "${APPLICATION_PATH}/modules/"
chmod -R 755 "${APPLICATION_PATH}/modules/"

# Apply the config file
php "${APPLICATION_PATH}/modules/autoupgrade/cli-updateconfig.php" --from="${APPLICATION_PATH}/modules/autoupgrade/config.json" --dir="${BACKOFFICE_FOLDER}"

# Run the upgrade
php "${APPLICATION_PATH}/modules/autoupgrade/cli-upgrade.php" --dir="${BACKOFFICE_FOLDER}"

info "Change owner to www-data:www-data"
find ${APPLICATION_PATH} -exec chown -R www-data:www-data {} +

info "Change mode of files to 644"
find ${APPLICATION_PATH} -type f -exec chmod 644 {} +

info "Change mode of directories to 755"
find ${APPLICATION_PATH} -type d -exec chmod 755 {} +

if [[ -f "${APPLICATION_PATH}/blauwfruit-juice-upgrade-${PRESTASHOP_NEW_VERSION}-hook-after" ]]; then

  bash "${APPLICATION_PATH}/blauwfruit-juice-upgrade-${PRESTASHOP_NEW_VERSION}-hook-after"

  if [[ $? -eq 0 ]]; then
    success "Upgrade Hook After executed without errors"
  else
    warning "Upgrade Hook After script has failed. See script " . "${APPLICATION_PATH}/blauwfruit-juice-upgrade-hook-after"
    warning "You're upgrade might still be successfully executed"
  fi
fi

success "See the front-office $SHOP_URL"
success "See the back-office $SHOP_URL/$BACKOFFICE_FOLDER"
